# Amperity Lambda Runner Deployments

There are several ways to deploy Lambdas. The AWS [Serverless Application Repository](https://us-east-1.console.aws.amazon.com/serverlessrepo/home?region=us-east-1#/available-applications) is the main way Amperity publishes supported Lambda code. We do have a [generic api](link tbd) application you can use, however, if there is any testing you would like to do before pushing to Lambda than this repository is the best place to start. If you do use this repository to test locally we provide tools to zip your Lambda logic and upload manually. 

## Amperity Deployed Applications

- [Generic API]()
- [Redshift]()
- [Rudderstack]()
- [AWS Pinpoint]()
- [AWS Connect]()

## Quickstart

The two main reasons you should be reading this doc are if you're deploying your Lambda using zip upload or you're an Amperity dev updating one of our AWS applications. Starting with deploying via zip, it is straightforward but will require a few changes to the deployed configuration to work correctly. Hopefully we've made this as easy as we can with clear descriptions of what to do but if there's something we're missing please let us know.

For creating or updating an AWS serverless app there are a few steps. The main thing of note here is to manually verify the packaged.yaml generated by SAM for any syntax errors, correct version, and proper naming.

### How to use the ZIP target

`make lambda-build filename={ your filename.py here }` is the target you are going to use. This will invoke a script in `util/` called lambda-build.sh. It's going to move a some files to `build/`, install some pip packages, and generate a zip from all of that. Next you upload that to Lambda using the "upload zip" feature. Finally you need to update a few of the configurations for your deployed Lambda. 

1. Set the "Handler" option in "Runtime Settings" to `app.lambda_handler`
1. Pick a desired timeout for your lambda in "Configuration -> General Configuration". The max is 15 minutes, and we recommend using that.
1. Add the correct IAM permissions described in [IAM permissions section](#How-to-setup-IAM-permissions-manually)

### How to use SAM target

You will need to [insall SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html) to run these commands.

Make sure your lambda handler is named the same as your README in `docs/`. The script looks for a README by that name (naively) and uses that as the README for the AWS serverless repo. The commands you will need to run are:

`make sam-build filename={ filename.py here } version={ version number }` 

`make sam-publish region={ valid AWS region }`

The first command populates `build/` with all necessary files, formats the `template.yaml` file, and runs the SAM command to upload all of that to S3. This should be enough for what you will be doing but it's worth manually double checking `build/packaged.yaml` and making sure everything is as it should be. You can run `sam validate -t build/template.yaml` and/or `sam validate -t build/packaged.yaml` if you want to another pair of eyes. 

Once you are confident in the `packaged.yaml` generated by the script/SAM then you can run the second command. That will actually publish the appication to the repository. If it succeeds you will get a URL to follow in the output from the SAM command. Verify the update is correct if that's all you're doing or check the new application for any issues in the README/LICENSE. You will need to make the application public once you are confident it is ready to be used.

## How to setup IAM permissions manually

If you are handling large amounts of data your lambda could reach the timeout enforced by AWS. This section explains how to configure the IAM policies necessary for your lambda to invoke itself and continue working. This is considered an anti-pattern by AWS but given the tools we can use it is the simplest solution for long-running jobs.

1. Copy function arn from your lambda page. (Function overview on the right side under description)
1. Open `Configuration -> Permissions` and open role associated with this lambda. (ie `Execution Role`)
1. In the new tab go to `Add permissions` and select `Attach policies`
1. You'll be moved to a new page and there you'll select `Create Policy`
1. Navigate to the JSON tab and copy in the below json. Make sure to replace `Resource` with your function arn.
~~~json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowLambdaToInvokeLambda",
            "Effect": "Allow",
            "Action": "lambda:InvokeFunction",
            "Resource": "{{ your function arn here }}"
        }
    ]
}
~~~
1. Create the policy and attach it to the lambda's role. 
1. You are good to go!
